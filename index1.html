<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MonAudioSite — Partage & Lecture MP3</title>
  <style>
    :root{--accent:#0b84ff;--bg:#f7fbff;--card:#fff}
    body{font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:#111;margin:0;padding:1rem}
    .container{max-width:980px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;gap:1rem}
    h1{font-size:1.3rem;margin:0}
    .card{background:var(--card);padding:1rem;border-radius:12px;box-shadow:0 6px 18px rgba(12,20,40,0.06);margin-top:1rem}
    button{background:var(--accent);color:#fff;border:none;padding:.5rem .8rem;border-radius:8px;cursor:pointer}
    .ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,132,255,0.2)}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    .muted{color:#666;font-size:.9rem}
    input[type=file]{display:block}
    .track{display:flex;align-items:center;gap:.5rem;padding:.5rem;border-radius:8px;border:1px solid #eef3fb;margin-bottom:.5rem}
    .track .meta{flex:1}
    .rolespan{padding:.2rem .4rem;border-radius:6px;background:#eef6ff;color:var(--accent);font-weight:600;font-size:.8rem}
    footer{margin-top:1rem;color:#666;font-size:.9rem}
    .danger{background:#ff4d4f}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>MonAudioSite</h1>
      <div class="row">
        <div id="user-info" class="muted">Non connecté</div>
        <button id="btn-login" class="ghost">Se connecter / S'inscrire</button>
      </div>
    </header>

    <section class="card">
      <strong>Compte et rôles</strong>
      <p class="muted">Rôles disponibles : <span class="rolespan">admin</span>, <span class="rolespan">friend</span>, invité (guest).</p>
      <div style="margin-top:.5rem" id="controls-auth"></div>
      <div id="invite-area" style="margin-top:.5rem;display:none">
        <button id="btn-generate-invite">Générer un code d'invitation</button>
        <span id="latest-invite" class="muted" style="margin-left:.5rem"></span>
      </div>
    </section>

    <section class="card" id="uploader">
      <strong>Ajouter une musique (MP3)</strong>
      <form id="upload-form">
        <input type="file" id="file" accept="audio/mp3,audio/*" required>
        <input type="text" id="title" placeholder="Titre (facultatif)" style="margin-top:.5rem;width:100%">
        <div class="row" style="margin-top:.5rem">
          <button type="submit">Ajouter en brouillon</button>
          <button type="button" id="btn-publish" class="ghost">Publier sélection</button>
        </div>
      </form>
      <p class="muted" style="margin-top:.5rem">Les fichiers sont stockés localement dans ton navigateur (pour prototype). Pour partager réellement, il faut un serveur / stockage (ex: S3, Firebase Storage).</p>
    </section>

    <section class="card">
      <strong>Liste des pistes</strong>
      <div id="tracks-list" style="margin-top:.6rem"></div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong>Actions rapides</strong>
        <div class="row">
          <button id="btn-invite" class="ghost">Inviter (afficher code)</button>
          <button id="btn-clac">Clac 4A</button>
        </div>
      </div>
      <p class="muted" style="margin-top:.6rem">Bouton <strong>Clac 4A</strong> : effet visuel et jingle court.</p>
    </section>

    <footer>Site prototype — ne publie pas de contenu protégé sans autorisation.</footer>
  </div>

  <audio id="clac-audio" src=""></audio>

  <script>
    // Stockage local: users, tracks, invites
    const DB = 'monaudiosite_v1';
    let state = JSON.parse(localStorage.getItem(DB) || '{}');
    if(!state.users) state.users = [
      {name:'admin', pass:'admin', role:'admin'}, 
      {name:'ami', pass:'ami', role:'friend'}
    ];
    if(!state.tracks) state.tracks = []; // {id,title,owner,blob,filename,published,created}
    if(!state.invites) state.invites = []; // codes
    if(!state.currentUser) state.currentUser = null;
    save();

    const userInfo = document.getElementById('user-info');
    const btnLogin = document.getElementById('btn-login');
    const controlsAuth = document.getElementById('controls-auth');
    const inviteArea = document.getElementById('invite-area');
    const latestInvite = document.getElementById('latest-invite');

    const uploadForm = document.getElementById('upload-form');
    const tracksList = document.getElementById('tracks-list');
    const btnGenerateInvite = document.getElementById('btn-generate-invite');
    const btnInvite = document.getElementById('btn-invite');
    const btnClac = document.getElementById('btn-clac');
    const clacAudio = document.getElementById('clac-audio');

    // Préparer un petit jingle DataURL (bip court) pour Clac (généré en base64 silence/ton simple)
    // Ici on crée un petit beep via WebAudio au clic au lieu d'un fichier.
    function playClac(){ try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type='square'; o.frequency.value = 880;
      o.connect(g); g.connect(ctx.destination);
      g.gain.value = 0.05;
      o.start(); setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
    }catch(e){ console.warn('Clac failed',e); } }

    function save(){ localStorage.setItem(DB, JSON.stringify(state)); }

    function renderAuth(){
      if(state.currentUser){
        userInfo.textContent = 'Connecté: ' + state.currentUser.name + ' • rôle: ' + state.currentUser.role;
        controlsAuth.innerHTML = `<div class="row"><button id="btn-logout" class="ghost">Déconnexion</button><button id="btn-edit" class="ghost">Mon profil</button></div>`;
        document.getElementById('btn-logout').addEventListener('click', ()=>{ state.currentUser=null; save(); renderAll(); });
        document.getElementById('btn-edit').addEventListener('click', ()=>{ alert('Utilisateur: '+state.currentUser.name+'\\nRôle: '+state.currentUser.role); });
        inviteArea.style.display = (state.currentUser.role==='admin' || state.currentUser.role==='friend') ? 'block' : 'none';
      } else {
        userInfo.textContent = 'Non connecté';
        controlsAuth.innerHTML = '';
        inviteArea.style.display = 'none';
      }
    }

    btnLogin.addEventListener('click', ()=>{
      const action = prompt('Tapez register pour créer un compte, login pour vous connecter, ou invite pour utiliser un code d\\'invitation');
      if(!action) return;
      if(action.toLowerCase()==='register'){
        const name = prompt('Nom d\\'utilisateur');
        if(!name) return alert('Annulé');
        if(state.users.find(u=>u.name===name)) return alert('Nom déjà pris');
        const pass = prompt('Mot de passe');
        if(!pass) return alert('Annulé');
        // user default guest role, requires invite to become friend/admin
        state.users.push({name,pass,role:'guest'}); state.currentUser = {name,role:'guest'};
        save(); renderAll(); alert('Compte créé (rôle invité). Si vous avez un code d\\'invitation, utilisez \"invite\".');
      } else if(action.toLowerCase()==='login'){
        const name = prompt('Nom d\\'utilisateur');
        const pass = prompt('Mot de passe');
        const u = state.users.find(u=>u.name===name && u.pass===pass);
        if(!u) return alert('Introuvable ou mot de passe incorrect');
        state.currentUser = {name:u.name,role:u.role}; save(); renderAll();
      } else if(action.toLowerCase()==='invite'){
        const code = prompt('Collez le code d\\'invitation');
        if(!code) return;
        const found = state.invites.find(i=>i.code===code && !i.used);
        if(!found) return alert('Code invalide ou déjà utilisé');
        // upgrade current user role to friend
        const name = prompt('Nom d\\'utilisateur existant à upgrader');
        const u = state.users.find(x=>x.name===name);
        if(!u) return alert('Utilisateur introuvable');
        u.role = found.role || 'friend'; found.used = true; save();
        alert('Compte '+name+' promu à '+u.role);
      }
    });

    uploadForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!state.currentUser){ return alert('Connectez-vous d\\'abord'); }
      const file = document.getElementById('file').files[0];
      if(!file) return alert('Choisir un fichier audio mp3');
      if(!file.type.startsWith('audio')) return alert('Le fichier doit être audio');
      const title = document.getElementById('title').value || file.name;
      // Lire en blob URL (ne pas stocker le binaire dans localStorage lourdement)
      const blob = file.slice(0, file.size, file.type);
      const id = 't_'+Date.now();
      const owner = state.currentUser.name;
      state.tracks.push({id,title,owner,filename:file.name,published:false,created:Date.now()});
      // stocker le fichier dans sessionStorage par clé dédiée (pour prototype) - plus sécurisé que localStorage pour gros fichiers
      try {
        const reader = new FileReader();
        reader.onload = function(evt){
          try{ sessionStorage.setItem('track_blob_'+id, evt.target.result); }catch(e){ console.warn('SessionStorage full',e); }
        };
        reader.readAsDataURL(blob);
      } catch(e){ console.warn('Erreur stockage blob',e); }
      save(); renderTracks(); alert('Piste ajoutée en brouillon. Publiez-la pour la rendre publique.');
      uploadForm.reset();
    });

    document.getElementById('btn-publish').addEventListener('click', ()=>{
      if(!state.currentUser) return alert('Connectez-vous d\\'abord');
      const myUnpublished = state.tracks.find(t=>t.owner===state.currentUser.name && !t.published);
      if(!myUnpublished) return alert('Pas de piste brouillon à publier');
      myUnpublished.published = true; save(); renderTracks(); alert('Piste publiée.');
    });

    btnGenerateInvite.addEventListener('click', ()=>{
      if(!state.currentUser) return alert('Connectez-vous d\\'abord');
      if(!(state.currentUser.role==='admin' || state.currentUser.role==='friend')) return alert('Seulement admin/ami peuvent générer des invitations');
      const code = Math.random().toString(36).slice(2,9).toUpperCase();
      const role = prompt('Rôle à attribuer avec ce code (friend/admin) — laisse vide pour friend') || 'friend';
      const obj = {code,role,created:Date.now(),used:false,by:state.currentUser.name};
      state.invites.push(obj); save();
      latestInvite.textContent = 'Code: '+code+' → rôle: '+role;
      alert('Code généré: '+code);
    });

    btnInvite.addEventListener('click', ()=>{
      if(state.invites.length===0) return alert('Aucun code d\\'invitation généré');
      const list = state.invites.map(i=>i.code+' ('+i.role+')(used:'+ (i.used?'oui':'non')+')').join('\\n');
      alert('Codes: \\n'+list);
    });

    btnClac.addEventListener('click', ()=>{
      // petit effet visuel + son court
      playClac();
      document.body.style.transition = 'background 0.3s';
      document.body.style.background = '#fff8e1';
      setTimeout(()=>{ document.body.style.background = 'var(--bg)'; }, 350);
    });

    function renderTracks(){
      tracksList.innerHTML = '';
      const list = state.tracks.slice().reverse();
      if(list.length===0){ tracksList.innerHTML = '<div class="muted">Aucune piste</div>'; return; }
      list.forEach(t=>{
        const div = document.createElement('div'); div.className='track';
        const meta = document.createElement('div'); meta.className='meta';
        const pub = t.published ? '✅ Publié' : '⏳ Brouillon';
        meta.innerHTML = `<strong>${escapeHtml(t.title)}</strong> <div class="muted">par ${escapeHtml(t.owner)} — ${pub}</div>`;
        const actions = document.createElement('div');
        // play button (creates audio element from sessionStorage blob)
        const btnPlay = document.createElement('button'); btnPlay.textContent = '▶'; btnPlay.title='Jouer';
        let audioEl = null;
        btnPlay.addEventListener('click', ()=>{
          if(!audioEl){
            const data = sessionStorage.getItem('track_blob_'+t.id);
            if(!data) return alert('Fichier non disponible (réessaie charger la page)');
            audioEl = new Audio(data);
            audioEl.addEventListener('ended', ()=>{ btnPlay.textContent = '▶'; });
            audioEl.play(); btnPlay.textContent = '⏸';
          } else if(!audioEl.paused){ audioEl.pause(); btnPlay.textContent = '▶'; }
          else { audioEl.play(); btnPlay.textContent = '⏸'; }
        });
        actions.appendChild(btnPlay);

        // delete (admin only or owner)
        const btnDelete = document.createElement('button'); btnDelete.textContent='Supprimer'; btnDelete.className='ghost';
        btnDelete.addEventListener('click', ()=>{
          if(!state.currentUser) return alert('Connectez-vous');
          const user = state.currentUser;
          if(user.role!=='admin' && user.name!==t.owner) return alert('Seul l\\'admin ou le propriétaire peut supprimer');
          if(!confirm('Supprimer la piste \"'+t.title+'\" ?')) return;
          // remove from state and sessionStorage
          state.tracks = state.tracks.filter(x=>x.id!==t.id);
          try{ sessionStorage.removeItem('track_blob_'+t.id); }catch(e){}
          save(); renderTracks();
        });
        actions.appendChild(btnDelete);

        // publish/unpublish (owner or admin)
        const btnToggle = document.createElement('button'); btnToggle.textContent = t.published?'Retirer':'Publier'; btnToggle.className='ghost';
        btnToggle.addEventListener('click', ()=>{
          if(!state.currentUser) return alert('Connectez-vous');
          const user = state.currentUser;
          if(user.role!=='admin' && user.name!==t.owner) return alert('Seul l\\'admin ou le propriétaire peut publier/retirer');
          t.published = !t.published; save(); renderTracks();
        });
        actions.appendChild(btnToggle);

        div.appendChild(meta);
        div.appendChild(actions);
        tracksList.appendChild(div);
      });
    }

    function renderAll(){ renderAuth(); renderTracks(); }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

    // initial render
    renderAll();
  </script>
</body>
</html>
